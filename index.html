<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hoho 3D ‚Äî Catch & Win</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --hoho-primary: #D62828;
      --hoho-secondary: #F77F00;
      --hoho-bg: #FFFFFF;
      --hoho-font: 'Rubik', sans-serif;
      --hoho-accent: #003049;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--hoho-font);
      background-color: var(--hoho-bg);
      color: var(--hoho-accent);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }

    header {
      text-align: center;
      margin-bottom: 1rem;
    }

    header h1 {
      color: var(--hoho-primary);
      font-size: 2rem;
      margin: 0;
    }

    #game-area {
      position: relative;
      width: 90vw;
      max-width: 400px;
      height: 400px;
      background: #eee;
      border: 3px solid var(--hoho-secondary);
      border-radius: 10px;
      overflow: hidden;
    }

    .target {
      position: absolute;
      width: 50px;
      height: 50px;
      background-color: var(--hoho-primary);
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .target:hover {
      transform: scale(1.2);
    }

    #controls {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #controls button {
      background-color: var(--hoho-primary);
      color: white;
      padding: 0.7rem 1.5rem;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 0.5rem;
    }

    #controls button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    #reward-select, #email-input {
      margin-top: 0.5rem;
      width: 100%;
      max-width: 300px;
      padding: 0.5rem;
      font-size: 1rem;
    }

    #leaderboard {
      margin-top: 2rem;
      width: 100%;
      max-width: 300px;
    }

    #leaderboard h3 {
      text-align: center;
      color: var(--hoho-secondary);
    }

    #leaderboard ul {
      list-style: none;
      padding: 0;
    }

    #leaderboard li {
      background: #f2f2f2;
      padding: 0.4rem;
      margin-bottom: 0.2rem;
      border-radius: 4px;
      text-align: center;
    }

    #message {
      margin-top: 1rem;
      color: var(--hoho-accent);
      font-weight: bold;
      min-height: 1.2em;
    }

    @media (max-width: 500px) {
      #game-area {
        height: 300px;
      }

      .target {
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>
<body>

  <header>
    <h1>üéØ Hoho 3D ‚Äî Catch & Win</h1>
  </header>

  <main>
    <div id="game-area" role="region" aria-label="Zona de juego">
      <!-- target se genera con JS -->
    </div>

    <div id="controls">
      <button id="start-btn" aria-label="Comenzar juego">Iniciar juego</button>

      <select id="reward-select" aria-label="Seleccionar premio">
        <option value="5%_desc">Cup√≥n 5% Descuento</option>
        <option value="0.25kg">Cup√≥n 250g Filamento Gratis</option>
      </select>

      <input type="email" id="email-input" placeholder="Tu correo" aria-label="Correo electr√≥nico"/>

      <div id="message" role="alert"></div>
    </div>

    <section id="leaderboard" aria-label="Tabla de r√©cords">
      <h3>üèÜ Mejores Tiempos</h3>
      <ul id="leaderboard-list">
        <!-- tiempos con JS -->
      </ul>
    </section>
  </main>

  <script>
  (() => {
    // =============================
    // üéÆ L√≥gica del Juego
    // =============================
    const game = (() => {
      let target = null;
      let startTime = 0;
      let cooldown = false;
      const COOLDOWN_TIME = 60000;
      const MAX_LEADERBOARD = 5;

      const gameArea = document.getElementById("game-area");
      const startBtn = document.getElementById("start-btn");
      const messageEl = document.getElementById("message");
      const leaderboardEl = document.getElementById("leaderboard-list");
      const emailInput = document.getElementById("email-input");
      const rewardSelect = document.getElementById("reward-select");

      function start() {
        if (cooldown) {
          showMessage("üïë Espera 1 minuto entre intentos.");
          return;
        }

        clearTarget();
        spawnTarget();
        startTime = Date.now();
        showMessage("¬°Atr√°palo!");
        hohoTrack("game_start", {});
      }

      function spawnTarget() {
        target = document.createElement("div");
        target.className = "target";
        target.setAttribute("role", "button");
        target.setAttribute("aria-label", "Objetivo del juego");

        const x = Math.random() * (gameArea.clientWidth - 50);
        const y = Math.random() * (gameArea.clientHeight - 50);
        target.style.left = `${x}px`;
        target.style.top = `${y}px`;

        target.addEventListener("click", win);
        gameArea.appendChild(target);
      }

      function clearTarget() {
        if (target) {
          target.remove();
          target = null;
        }
      }

      function win() {
        const time = (Date.now() - startTime) / 1000;
        clearTarget();
        showMessage(`üéâ ¬°Lo atrapaste en ${time.toFixed(2)}s!`);
        hohoTrack("game_win", { time });

        updateLeaderboard(time);
        const email = emailInput.value.trim();
        if (validateEmail(email)) {
          sendCoupon(email, rewardSelect.value, time);
        } else {
          showMessage("Por favor, ingresa un correo v√°lido para recibir tu cup√≥n.");
        }

        applyCooldown();
      }

      function updateLeaderboard(time) {
        const scores = getLeaderboard();
        scores.push(time);
        scores.sort((a, b) => a - b);
        const top = scores.slice(0, MAX_LEADERBOARD);
        localStorage.setItem("hoho3d_leaderboard", JSON.stringify(top));
        renderLeaderboard();
      }

      function getLeaderboard() {
        return JSON.parse(localStorage.getItem("hoho3d_leaderboard")) || [];
      }

      function renderLeaderboard() {
        const scores = getLeaderboard();
        leaderboardEl.innerHTML = "";
        scores.forEach((t, i) => {
          const li = document.createElement("li");
          li.textContent = `${i + 1}. ${t.toFixed(2)}s`;
          leaderboardEl.appendChild(li);
        });
      }

      function applyCooldown() {
        cooldown = true;
        startBtn.disabled = true;
        setTimeout(() => {
          cooldown = false;
          startBtn.disabled = false;
          showMessage("Listo para otro intento.");
        }, COOLDOWN_TIME);
      }

      function showMessage(msg) {
        messageEl.textContent = msg;
      }

      return {
        init: () => {
          renderLeaderboard();
          startBtn.addEventListener("click", start);
        }
      };
    })();

    // =============================
    // üì© Validaci√≥n de Email
    // =============================
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(String(email).toLowerCase());
    }

    // =============================
    // üìà Anal√≠tica personalizada
    // =============================
    window.hohoTrack = function(eventName, payload) {
      console.log(`[Analytics] ${eventName}`, payload);
      // window.gtag?.('event', eventName, payload); // Activar si usas GA4
    };

    // =============================
    // üßæ Solicitud de Cup√≥n (JSONP)
    // =============================
    function sendCoupon(email, reward, time) {
      const token = "hoho3d_secret_token"; // üëà C√°mbialo en producci√≥n
      const url = `https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec` +
        `?callback=handleCouponResponse&email=${encodeURIComponent(email)}` +
        `&reward=${encodeURIComponent(reward)}&time=${time.toFixed(2)}` +
        `&token=${token}`;

      const script = document.createElement("script");
      script.src = url;
      document.body.appendChild(script);

      hohoTrack("coupon_requested", { email, reward });
    }

    window.handleCouponResponse = function(response) {
      if (response.status === "ok") {
        document.getElementById("message").textContent = `üéÅ Cup√≥n enviado: ${response.coupon}`;
        hohoTrack("coupon_sent", { coupon: response.coupon });
      } else {
        document.getElementById("message").textContent = `‚ö†Ô∏è ${response.message}`;
        hohoTrack("coupon_failed", { reason: response.message });
      }
    };

    // =============================
    // üöÄ Inicializar Juego
    // =============================
    document.addEventListener("DOMContentLoaded", game.init);
  })();
  </script>
</body>
</html>
